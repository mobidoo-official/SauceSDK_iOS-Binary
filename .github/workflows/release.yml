name: Release and Deploy

# ë°°í¬ìš© ë ˆí¬ì— íƒœê·¸ê°€ í‘¸ì‹œë  ë•Œ ì‹¤í–‰
on:
  push:
    tags:
      - 'v*.*.*'

jobs:
  release-and-deploy:
    name: ðŸš€ Release and Deploy
    runs-on: macos-14
    
    steps:
    # 1. ì½”ë“œ ì²´í¬ì•„ì›ƒ
    - name: ðŸ“¥ Checkout Repository
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
    
    # 2. ë²„ì „ ì •ë³´ ì¶”ì¶œ
    - name: ðŸ“‹ Extract Version Info
      id: version
      run: |
        VERSION=${GITHUB_REF#refs/tags/}
        VERSION_NUMBER=${VERSION#v}
        echo "version=$VERSION" >> $GITHUB_OUTPUT
        echo "version_number=$VERSION_NUMBER" >> $GITHUB_OUTPUT
        echo "ðŸ·ï¸ ë°°í¬ ë²„ì „: $VERSION"
    
    # 3. ë¦´ë¦¬ì¦ˆ ë…¸íŠ¸ ìƒì„±
    - name: ðŸ“ Generate Release Notes
      run: |
        cat > release_notes.md << EOF
        # SauceSDK ${{ steps.version.outputs.version }}
        
        ## ðŸ“¦ ë°°í¬ ì •ë³´
        - **ë¹Œë“œ ë‚ ì§œ**: $(date '+%Y-%m-%d %H:%M:%S UTC')
        - **ì•„í‚¤í…ì²˜**: iOS Device (arm64) + Simulator (arm64, x86_64)
        - **íŒŒì¼ í¬ê¸°**: $(ls -lh SauceSDK.xcframework.zip | awk '{print $5}')
        
        ## ðŸš€ ì„¤ì¹˜ ë°©ë²•
        
        ### Swift Package Manager
        \`\`\`swift
        dependencies: [
            .package(url: "https://github.com/mobidoo-official/SauceSDK_iOS-Binary", from: "${{ steps.version.outputs.version_number }}")
        ]
        \`\`\`
        
        ### CocoaPods
        \`\`\`ruby
        pod 'SauceSDK', '~> ${{ steps.version.outputs.version_number }}'
        \`\`\`
        
        ### ì§ì ‘ ë‹¤ìš´ë¡œë“œ
        1. \`SauceSDK.xcframework.zip\` ë‹¤ìš´ë¡œë“œ
        2. ì••ì¶• í•´ì œ í›„ í”„ë¡œì íŠ¸ì— ë“œëž˜ê·¸ ì•¤ ë“œë¡­
        
        ## ðŸ” ì²´í¬ì„¬ ê²€ì¦
        \`\`\`bash
        shasum -a 256 SauceSDK.xcframework.zip
        # $(shasum -a 256 SauceSDK.xcframework.zip | awk '{print $1}')
        \`\`\`
        
        ## ðŸ“š ì‚¬ìš©ë²•
        \`\`\`swift
        import SauceSDK
        
        // SDK ì´ˆê¸°í™”
        SauceClient.initInstance(partnerID: "your-partner-id")
        
        // ë¼ì´ë¸Œ í”Œë ˆì´ì–´
        let liveClient = SauceLivePlayerClient.getInstance()
        
        // í´ë¦½ í”Œë ˆì´ì–´  
        let clipClient = SauceClipPlayerClient.getInstance()
        
        // ì‡¼ë£¸
        let showRoomClient = ShowRoomClient.getInstance()
        \`\`\`
        EOF
        
        echo "âœ… ë¦´ë¦¬ì¦ˆ ë…¸íŠ¸ ìƒì„± ì™„ë£Œ"
    
    # 4. ì²´í¬ì„¬ íŒŒì¼ ìƒì„± (ì—†ëŠ” ê²½ìš°)
    - name: ðŸ” Generate Checksum
      run: |
        if [ ! -f "SauceSDK.xcframework.zip.sha256" ]; then
          echo "ðŸ” ì²´í¬ì„¬ íŒŒì¼ ìƒì„± ì¤‘..."
          shasum -a 256 SauceSDK.xcframework.zip > SauceSDK.xcframework.zip.sha256
        fi
        
        echo "ðŸ“„ ì²´í¬ì„¬: $(cat SauceSDK.xcframework.zip.sha256)"
    
    # 5. GitHub Release ìƒì„±
    - name: ðŸš€ Create GitHub Release
      uses: softprops/action-gh-release@v1
      with:
        tag_name: ${{ steps.version.outputs.version }}
        name: SauceSDK ${{ steps.version.outputs.version }}
        body_path: release_notes.md
        files: |
          SauceSDK.xcframework.zip
          SauceSDK.xcframework.zip.sha256
        draft: false
        prerelease: false
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
    
    # 6. Ruby í™˜ê²½ ì„¤ì • (CocoaPodsìš©)
    - name: ðŸ’Ž Setup Ruby
      uses: ruby/setup-ruby@v1
      with:
        ruby-version: '3.2'
        bundler-cache: true
    
    # 7. CocoaPods ì„¤ì¹˜
    - name: ðŸ“¦ Install CocoaPods
      run: |
        gem install cocoapods
        pod --version
    
    # 8. CocoaPods ë°°í¬
    - name: ðŸš€ Deploy to CocoaPods
      env:
        COCOAPODS_TRUNK_TOKEN: ${{ secrets.COCOAPODS_TRUNK_TOKEN }}
      run: |
        if [ -z "$COCOAPODS_TRUNK_TOKEN" ]; then
          echo "âš ï¸ COCOAPODS_TRUNK_TOKENì´ ì„¤ì •ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤."
          echo "CocoaPods ë°°í¬ë¥¼ ê±´ë„ˆëœë‹ˆë‹¤."
          exit 0
        fi
        
        echo "ðŸ” Podspec ê²€ì¦ ì¤‘..."
        pod spec lint SauceSDK.podspec --allow-warnings --verbose
        
        echo "ðŸš€ CocoaPodsì— ë°°í¬ ì¤‘..."
        pod trunk push SauceSDK.podspec --allow-warnings --verbose
        
        echo "âœ… CocoaPods ë°°í¬ ì™„ë£Œ!"
        echo "ðŸ“¦ ì„¤ì¹˜ ë°©ë²•: pod 'SauceSDK', '~> ${{ steps.version.outputs.version_number }}'"
    
    # 9. ë°°í¬ ê²°ê³¼ ìš”ì•½
    - name: ðŸ“Š Deployment Summary
      if: always()
      run: |
        echo "## ðŸŽ‰ SauceSDK ${{ steps.version.outputs.version }} ë°°í¬ ì™„ë£Œ!" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "| ë°°í¬ ì±„ë„ | ìƒíƒœ |" >> $GITHUB_STEP_SUMMARY
        echo "|----------|------|" >> $GITHUB_STEP_SUMMARY
        echo "| GitHub Release | âœ… ì™„ë£Œ |" >> $GITHUB_STEP_SUMMARY
        echo "| CocoaPods | ${{ env.COCOAPODS_TRUNK_TOKEN && 'âœ… ì™„ë£Œ' || 'âš ï¸ ê±´ë„ˆëœ€' }} |" >> $GITHUB_STEP_SUMMARY
        echo "| Swift Package Manager | âœ… ì™„ë£Œ |" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### ðŸ“¦ ì„¤ì¹˜ ë°©ë²•" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "**CocoaPods:**" >> $GITHUB_STEP_SUMMARY
        echo "\`\`\`ruby" >> $GITHUB_STEP_SUMMARY
        echo "pod 'SauceSDK', '~> ${{ steps.version.outputs.version_number }}'" >> $GITHUB_STEP_SUMMARY
        echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "**Swift Package Manager:**" >> $GITHUB_STEP_SUMMARY
        echo "\`\`\`swift" >> $GITHUB_STEP_SUMMARY
        echo "dependencies: [" >> $GITHUB_STEP_SUMMARY
        echo "    .package(url: \"https://github.com/mobidoo-official/SauceSDK_iOS-Binary\", from: \"${{ steps.version.outputs.version_number }}\")" >> $GITHUB_STEP_SUMMARY
        echo "]" >> $GITHUB_STEP_SUMMARY
        echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
